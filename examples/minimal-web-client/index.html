<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Minimal Chat Client</title>
    <style>
      :root {
        --bg: #0f172a;
        --panel: #111827;
        --text: #e5e7eb;
        --muted: #9ca3af;
        --accent: #3b82f6;
        --bubble-user: #1f2937;
        --bubble-assistant: #0b3b87;
        --border: #1f2937;
      }
      * { box-sizing: border-box; }
      body { margin: 0; background: var(--bg); color: var(--text); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, Noto Sans, Apple Color Emoji, Segoe UI Emoji; }
      .container { display: grid; grid-template-rows: auto 1fr auto; height: 100vh; }
      header { padding: 12px 16px; border-bottom: 1px solid var(--border); background: var(--panel); display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
      header input[type="text"], header textarea { background: #0b1220; color: var(--text); border: 1px solid var(--border); border-radius: 6px; padding: 8px 10px; font-size: 14px; }
      header .btn { background: var(--accent); color: white; border: none; border-radius: 6px; padding: 8px 12px; cursor: pointer; font-weight: 600; }
      header .btn.secondary { background: #374151; }
      main { padding: 16px; overflow: auto; }
      .messages { display: flex; flex-direction: column; gap: 12px; max-width: 820px; margin: 0 auto; }
      .msg { display: flex; gap: 12px; }
      .msg .role { font-size: 12px; color: var(--muted); width: 86px; text-align: right; padding-top: 6px; flex-shrink: 0; }
      .msg .bubble { max-width: 100%; white-space: pre-wrap; background: var(--bubble-assistant); padding: 12px 14px; border-radius: 10px; border: 1px solid var(--border); }
      .msg.user .bubble { background: var(--bubble-user); }
      .typing { max-width: 820px; margin: 0 auto; }
      .dots span { display: inline-block; width: 6px; height: 6px; margin: 0 2px; background: #cbd5e1; border-radius: 50%; opacity: .3; animation: blink 1.4s infinite; }
      .dots span:nth-child(2) { animation-delay: .2s; }
      .dots span:nth-child(3) { animation-delay: .4s; }
      @keyframes blink { 0%, 80%, 100% { opacity: .3 } 40% { opacity: 1 } }
      footer { padding: 12px 16px; border-top: 1px solid var(--border); background: var(--panel); }
      .composer { display: flex; gap: 10px; max-width: 820px; margin: 0 auto; }
      .composer textarea { flex: 1; min-height: 44px; max-height: 200px; resize: vertical; background: #0b1220; color: var(--text); border: 1px solid var(--border); border-radius: 10px; padding: 10px 12px; font-size: 15px; }
      .composer .btn { background: var(--accent); color: white; border: none; border-radius: 10px; padding: 10px 16px; cursor: pointer; font-weight: 700; }
      .meta { font-size: 12px; color: var(--muted); margin-top: -4px; margin-bottom: 10px; text-align: center; }
      .error { color: #fca5a5; }
      code, pre { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 13px; }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <strong>Minimal Chat Client</strong>
        <span class="meta" id="status"></span>
      </header>
      <main>
        <div class="messages" id="messages"></div>
        <div class="typing" id="typing" hidden>
          <div class="msg assistant">
            <div class="role">assistant</div>
            <div class="bubble"><span class="dots"><span></span><span></span><span></span></span></div>
          </div>
        </div>
      </main>
      <footer>
        <div class="composer">
          <textarea id="userInput" placeholder="Type your message... Enter to send (Shift+Enter for newline)"></textarea>
          <button class="btn" id="sendBtn">Send</button>
        </div>
        <div class="meta">Sends requests to the adapter. No data persistence.</div>
      </footer>
    </div>

    <script>
      const els = {
        messages: document.getElementById('messages'),
        userInput: document.getElementById('userInput'),
        sendBtn: document.getElementById('sendBtn'),
        status: document.getElementById('status'),
        typing: document.getElementById('typing'),
      };

      const API_URL = 'http://localhost:8000/v1/chat/completions';

      let conversation = [];
      let sending = false;
      let isComposing = false; // IME composition state

      function setStatus(text, isError = false) {
        els.status.textContent = text || '';
        els.status.className = 'meta' + (isError ? ' error' : '');
      }

      function render() {
        els.messages.innerHTML = '';
        for (const m of conversation) {
          const row = document.createElement('div');
          row.className = 'msg ' + m.role;
          const role = document.createElement('div');
          role.className = 'role';
          role.textContent = m.role;
          const bubble = document.createElement('div');
          bubble.className = 'bubble';
          bubble.textContent = m.content;
          row.appendChild(role);
          row.appendChild(bubble);
          els.messages.appendChild(row);
        }
        els.messages.scrollTop = els.messages.scrollHeight;
      }

      async function sendMessage() {
        if (sending) return;
        const content = els.userInput.value.trim();
        if (!content) return;

        // Append user message and render immediately
        conversation.push({ role: 'user', content });
        els.userInput.value = '';
        render();

        // Build payload
        const payload = {
          model: 'claude-code',
          messages: [
            ...conversation,
          ],
        };

        sending = true;
        els.sendBtn.disabled = true;
        els.userInput.disabled = true;
        els.typing.hidden = false;
        setStatus('Sending...');

        try {
          const resp = await fetch(API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          });

          if (!resp.ok) {
            const err = await safeJson(resp);
            throw new Error(err?.error?.message || `HTTP ${resp.status}`);
          }

          const data = await resp.json();
          const content = data?.choices?.[0]?.message?.content ?? '';
          conversation.push({ role: 'assistant', content });
          render();
          setStatus('');
        } catch (e) {
          console.error(e);
          setStatus(e.message || 'Request failed', true);
        } finally {
          sending = false;
          els.sendBtn.disabled = false;
          els.userInput.disabled = false;
          els.typing.hidden = true;
        }
      }

      async function safeJson(resp) {
        try { return await resp.json(); } catch { return null; }
      }

      // Wire events
      els.sendBtn.addEventListener('click', sendMessage);
      els.userInput.addEventListener('compositionstart', () => { isComposing = true; });
      els.userInput.addEventListener('compositionend', () => { isComposing = false; });
      els.userInput.addEventListener('keydown', (e) => {
        if (isComposing) return; // avoid sending while using IME
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });

      // Initial render
      render();
    </script>
  </body>
  </html>
